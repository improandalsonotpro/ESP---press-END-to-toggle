_G.FriendColor = Color3.fromRGB(0, 0, 255)
_G.EnemyColor = Color3.fromRGB(255, 0, 0)
_G.UseTeamColor = true

--------------------------------------------------------------------
local Holder = Instance.new("Folder", game.CoreGui)
Holder.Name = "ESP"

local Box = Instance.new("BoxHandleAdornment")
Box.Name = "nilBox"
Box.Size = Vector3.new(1, 2, 1)
Box.Color3 = Color3.new(100 / 255, 100 / 255, 100 / 255)
Box.Transparency = 0.7
Box.ZIndex = 0
Box.AlwaysOnTop = false
Box.Visible = false

local NameTag = Instance.new("BillboardGui")
NameTag.Name = "nilNameTag"
NameTag.Enabled = false
NameTag.Size = UDim2.new(0, 200, 0, 50)
NameTag.AlwaysOnTop = true
NameTag.StudsOffset = Vector3.new(0, 1.8, 0)
local Tag = Instance.new("TextLabel", NameTag)
Tag.Name = "Tag"
Tag.BackgroundTransparency = 1
Tag.Position = UDim2.new(0, -50, 0, 0)
Tag.Size = UDim2.new(0, 300, 0, 20)
Tag.TextSize = 15
Tag.TextColor3 = Color3.new(100 / 255, 100 / 255, 100 / 255)
Tag.TextStrokeColor3 = Color3.new(0, 0, 0)
Tag.TextStrokeTransparency = 0.4
Tag.Text = "nil"
Tag.Font = Enum.Font.SourceSansBold
Tag.TextScaled = false

local function LoadCharacter(v)
	repeat task.wait() until v.Character ~= nil
	v.Character:WaitForChild("Humanoid")
	local vHolder = Holder:FindFirstChild(v.Name)
	if not vHolder then return end
	vHolder:ClearAllChildren()
	local b = Box:Clone()
	b.Name = v.Name .. "Box"
	b.Adornee = v.Character
	b.Parent = vHolder
	local t = NameTag:Clone()
	t.Name = v.Name .. "NameTag"
	t.Enabled = true
	t.Parent = vHolder
	t.Adornee = v.Character:WaitForChild("Head", 5)
	if not t.Adornee then
		return UnloadCharacter(v)
	end
	t.Tag.Text = v.Name
	b.Color3 = Color3.new(v.TeamColor.r, v.TeamColor.g, v.TeamColor.b)
	t.Tag.TextColor3 = Color3.new(v.TeamColor.r, v.TeamColor.g, v.TeamColor.b)
	local Update
	local function UpdateNameTag()
		if not pcall(function()
			v.Character.Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
			local _ = math.floor(v.Character.Humanoid.MaxHealth)
			local _ = math.floor(v.Character.Humanoid.Health)
		end) then
			Update:Disconnect()
		end
	end
	UpdateNameTag()
	Update = v.Character.Humanoid.Changed:Connect(UpdateNameTag)
end

function UnloadCharacter(v)
	local vHolder = Holder:FindFirstChild(v.Name)
	if vHolder then
		vHolder:ClearAllChildren()
	end
end

local function LoadPlayer(v)
	local vHolder = Instance.new("Folder", Holder)
	vHolder.Name = v.Name
	v.CharacterAdded:Connect(function()
		pcall(LoadCharacter, v)
	end)
	v.CharacterRemoving:Connect(function()
		pcall(UnloadCharacter, v)
	end)
	v.Changed:Connect(function(prop)
		if prop == "TeamColor" then
			UnloadCharacter(v)
			task.wait()
			LoadCharacter(v)
		end
	end)
	LoadCharacter(v)
end

local function UnloadPlayer(v)
	UnloadCharacter(v)
	local vHolder = Holder:FindFirstChild(v.Name)
	if vHolder then
		vHolder:Destroy()
	end
end

for _,v in pairs(game:GetService("Players"):GetPlayers()) do
	task.spawn(function() pcall(LoadPlayer, v) end)
end

game:GetService("Players").PlayerAdded:Connect(function(v)
	pcall(LoadPlayer, v)
end)

game:GetService("Players").PlayerRemoving:Connect(function(v)
	pcall(UnloadPlayer, v)
end)

game:GetService("Players").LocalPlayer.NameDisplayDistance = 0

if _G.Reantheajfdfjdgs then
    return
end

_G.Reantheajfdfjdgs = true

local players = game:GetService("Players")
local plr = players.LocalPlayer

-- ESP TOGGLE SYSTEM (fixed)
local UserInputService = game:GetService("UserInputService")
local espEnabled = true  -- ESP starts ON by default

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.End then
		espEnabled = not espEnabled

		-- Toggle BoxHandleAdornment (they're under Holder per-player folders)
		for _, desc in pairs(Holder:GetDescendants()) do
			if desc:IsA("BoxHandleAdornment") then
				desc.Visible = espEnabled
			elseif desc:IsA("BillboardGui") then
				desc.Enabled = espEnabled
			end
		end

		-- Toggle Highlight instances (these live under characters)
		for _, pl in pairs(players:GetPlayers()) do
			if pl.Character then
				local h = pl.Character:FindFirstChild("GetReal")
				if h and h:IsA("Highlight") then
					h.Enabled = espEnabled
				end
			end
		end
	end
end)

function esp(target, color)
	-- Always update or create; respect espEnabled for visibility
	if target.Character then
		if not target.Character:FindFirstChild("GetReal") then
			local highlight = Instance.new("Highlight")
			highlight.RobloxLocked = true
			highlight.Name = "GetReal"
			highlight.Adornee = target.Character
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.FillColor = color
			highlight.Parent = target.Character
			highlight.Enabled = espEnabled
		else
			local h = target.Character:GetFirstChild("GetReal")
			if h and h:IsA("Highlight") then
				h.FillColor = color
				h.Enabled = espEnabled
			end
		end
	end
end

while task.wait() do
	for _, v in pairs(players:GetPlayers()) do
		if v ~= plr then
			esp(v, _G.UseTeamColor and v.TeamColor.Color or ((plr.TeamColor == v.TeamColor) and _G.FriendColor or _G.EnemyColor))
		end
	end
end
